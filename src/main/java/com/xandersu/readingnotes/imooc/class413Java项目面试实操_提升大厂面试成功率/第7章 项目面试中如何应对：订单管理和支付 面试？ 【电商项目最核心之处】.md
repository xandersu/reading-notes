# 第7章 项目面试中如何应对：订单管理和支付 面试？ 【电商项目最核心之处】

- 包含商品、优惠、用户、收货信息、支付信息等一系列实时数据
  - 数据修改如何处理
- 大型电商系统订单更复杂，包括订单自动合并与拆分、自动匹配仓库、自动计算库存、自动匹配快递、结算与支付等作业

## 电商核心模块

1. 商品模块
2. 订单模块
3. 支付模块

## 订单表

- 订单号、状态数据
- 收货人、地址、电话、留言
- 总价、邮费、各种减免、订单价、实付价
- 支付人、付款时间
- 发货信息、收货信息

## 订单商品表

- 主键、订单编号
- spu编号、sku编号、名称、规格
- 商品价格（下单时商品价格，不是付款时实际的价格）
- 评价信息

## 购物车记录

- 通常来说购物车中的记录要持久化存储，存放在NoSQL数据库居多



## 面试题

1. 订单生成流程

   我们的系统有团购、优惠券、购物积分等功能。用户下的订单，后台系统做数据验证，内容验证，优惠券id是否存在、优惠券、团购的期限。计算订单总价，计算团购、优惠券、积分减免金额，邮费，计算订单价格，订单价格等于商品总价 = 团购 - 优惠券 - 积分减免金额，购物是否满88元减免邮费。然后更新优惠券为已使用，记录用户参加了哪项团购活动，最后根据用户下单数量扣减库存，跳转支付页面等待支付。

2. 商品下架了，用户没有刷新页面就下单了，程序如何处理？

   生成订单时，会验证数据格式和数据有效性，验证商品是否存在和是否下架，如果已经下架给前台返回状态码，告知用户商品已下架。

3. 扣减库存是什么时候？订单取消后，怎么恢复库存？

   首先扣减库存是在下订单之后，而不是付款成功之后，保证用户下单成功就一定能买到商品。

   如果用户取消订单或长时间未付款，系统会自动取消订单，取消后自动释放库存。

4. 扣减库存怎么能保证幂等性？

   幂等性：不管一个人还是多个人操作，结果不能出现错误。

   1. 数据库事务级别改为串行化，但所有数据库操作都串行化了，严重影响并发。
   2. 对数据库进行加锁，但容易引发死锁。
   3. 给数据表加乐观锁。

   ***不要一上来就回答正确答案，列举多种方案，分析优缺点，最后告诉面试官正确答案，会让面试官认为思维广，专研技术。***

5. 怎么保证订单号不重复？

   *主键不等同于订单号。*

   雪花算法生成订单号，结合了时间戳、主机id、随机数，但是在高并发还是容易出现相同的订单号，可以增加订单号长度减少重复的可能。

6. 订单号和流水号是不是一回事？

   *订单号会包含时间戳但不包含业务信息。这些业务信息可以记录在流水号里，发货人员看流水号就知道商品类型和发货物流。*

   用途不同，流水号是对内公开的，包含一些业务信息，比如商品是固体还是液体，是不是易碎品，走空运还是陆运。流水号的作用是工作人员或者机器人不需要查询数据库就知道怎么发货。订单号是对外开放的，不包含业务数据库，只包含时间戳就可以。

7. 订单记录怎么引用收货人地址？

   订单记录不能引用收货热人地址id，因为顾客可能修改了收货地址，那之前的所有订单的地址都同时更新了，以前的收货地址要用以前的地址不能受到地址更新的影响；所以我把收货地址直接保存在订单记录中，不受地址修改的影响。

8. 订单表怎么设计？

   订单模块用到了订单表和订单商品表，因为一个订单可以包含多个商品，是一对多的；

9. 有没有订单拆分的功能

   不同发货地拆分成不同的订单

   最近的仓库没有货，调配最近、邮费最低的仓库，来拆分。

10. 订单有几种取消的形式？

    三类。一、顾客主动取消。二、客服或者商家取消订单，在没有发货时可以取消订单。三、顾客超过时间没有付款，系统自动取消订单。



## 移动支付平台

主流 微信、支付宝、云闪付

### 移动支付形式

APP => APP支付

小程序 => 小程序支付

网站 => JSAPI支付

线下扫码器 => Native支付

### 小程序开通微信支付的条件

- 企业才能申请小程序微信支付，个人主体的小程序不能申请
- 微信开发者公众号必须要通过企业认证的审核，才能申请移动支付功能

### 微信支付接口规则

- HTTPS
- POST
- 提交和返回结果都是XML格式，根节点是<xml>
- UTF-8编码

### 微信支付接口参数

- 交易金额单位为分，并且不能有小数点，最低金额为1元  150元=150
- 小程序交易类型（trade_type）是JSAPI
- 境内商户必须是人民币交易



## 面试题

1. 小程序支付流程

   牵扯到三个平台：小程序、商户系统、微信平台，用户在小程序上点击付款按钮，发送请求，告诉商户用户要为哪个商品订单付款，商户系统会检查商品订单的信息，是否存在商品订单的记录、订单是否取消或者过期，商户系统向微信平台上传商品订单的信息，申请创建支付订单，微信平台创建支付订单后返回给商户系统，商户系统把这些信息返回小程序，小程序验证数据，拿这个支付订单编号去微信平台查询信息，用户手机弹出支付信息，用户输入密码支付，成功后会把支付的信息发给小程序和商户系统，得到回调后修改订单状态为已支付。

2. JSAPI支付、H5支付、小程序支付的区别？

   JSAPI支付用在网页版的商城里，微信里打开商城网页支付使用JSAPI。

   用户在手机用浏览器打开，支付使用H5支付

   小程序在小程序支付

3. 微信支付的数字签名怎么生成的？

   使用SDK生成

   对字符串进行MD5运算

4. 支付成功后，商户没有收到通知怎么办？

   网络或者平台的原因没收到通知。

   没有收到通知不会将订单修改为已支付。

   第一种：用户付款成功后，小程序请求商户系统更改支付状态。

   第二种：商户系统定时检查订单是否已支付，小型系统可以，但是大型系统未支付很多，不能用。

5. 微信平台支付订单不付款的超时时间多久？

   2小时

6. 微信支付的return_code和result_code区别是什么？

   return_code：通信状态码，success说明微信已经收到请求，并不意味着成功处理请求

   result_code：成功处理请求

7. 如果用户支付成功，但是看到订单状态未支付，于是又支付了一次，系统怎么避免？

   用户发起支付成功后，商户会检查订单状态，修改订单状态为已支付。

   再次点击支付会检查订单的支付状态。商户系统会根据支付订单id查询微信平台是否支付成功，成功就更新支付状态，并告诉用户不要重复付款。如果没有付款成功，会关闭该支付订单，重新创建支付订单。

8. 用户长时间未付款，商户系统应不应该关闭订单？会出现什么后果？

   商户系统应该关闭订单，但是不关闭支付订单，创建新的支付订单。超时为24小时，订单24小时不自付则关闭订单。可能出现在关闭订单同时，用户付款成功了，这是修改订单由已关闭变为已支付。

9. 会不会出现微信支付失败，银行卡扣款成功的结果？

   有可能。微信平台发送扣款请求给银行系统，银行系统成功扣款，微信平台没有收到银行系统的扣款成功的返回，认为扣款失败。用户可以等待24小时，微信每天都会和银行对账，如果发现银行扣款成功，会发送消息给商户系统和小程序。如果24小时还未收到，可以联系客服。

10. 移动支付平台会不会出现重复扣款的现象？

    有可能出现，概率比较低。

























