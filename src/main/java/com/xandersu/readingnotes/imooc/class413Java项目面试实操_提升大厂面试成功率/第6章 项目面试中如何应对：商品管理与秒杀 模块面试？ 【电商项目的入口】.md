# 第6章 项目面试中如何应对：商品管理与秒杀 模块面试？

## SPU和SKU

商品模块最关键的是把商品信息保存明白

- SPU（标准化产品单元）是商品的公共信息
- SKU（库存度量单位）是商品最小存货单元

## 面试问题

1. 什么是SPU和SKU？

   spu商品公共信息。

   sku商品规格信息。

   小米手机操作系统、屏幕大小、电池大小，SPU

   颜色和容量规格SKU

   SPU记录对应多条SKU记录

2. 如果删除SPU记录，SKU记录怎么处理？

   物理删除SPU，删除之前需要判断是否有关联的订单，没有则连带物理删除SKU记录。

   逻辑删除SPU，SPU delete字段设置为true，SKU字段delete字段设置为true

3. 你做的电商系统是单商铺还是多商铺？

    多商铺之间的数据要做隔离不能交叉访问，设计表时需要引入商铺表，SPU关联商铺的id

4. 如何避免客户投诉时，商家随意篡改商品信息？

   只要商家编辑商品都会形成一条新的商品记录，用户根据订单查询商品时，不是最新商品记录而是下订单是的商品记录。mysql超过两千万条时，性能会变差，所以应该单独创建SPU和SKU的归档数据表，把归档数据转移存储，冷热数据分离。

5. 删除商品记录是用逻辑删除还是物理删除？

   逻辑

6. 怎么提高商品信息的加载速度？

   1. 提高前端速度有很多种优化方案。
   2. 首先是数据库方面的优化，优化SQL语句，多利用索引，设置innoDB缓冲池，增加数据库线程数量，增加数据库连接池数量；MYSQL数据分区技术。数据库使用集群、数据分库分表、读写分离、冷热数据分离；
   3. 后台引入缓存，热点业务数据缓存到redis中，命中缓存不走数据库；
   4. 网络连接方式可以改成NIO，用少量的线程可以处理更多的网络请求；增加tomcat线程数量，增加数据吞吐能力，tomcat负载均衡；CDN服务缓存静态图片和网页；
   5. 前端减少HTTP请求，尽量合并http请求，素材图片使用雪花图，商品图片使用延时加载。

7. 电商系统是否支持顾客根据参数查找商品？

   使用ES，全文搜索引擎。

   录入商品后，保存到SPU、SKU数据表里，然后把用来检索的参数和商品名称以及主键值写到ES里，用户检索商品时到ES查找得到商品的ID，在数据库里提取商品的信息，在渲染到页面上。

8. 既然使用了ES，SKU数据表还有什么意义？

   ES不能替代SKU数据表，es用来检索数据，但是ES没有存放商品的全部信息，只是存放用来检索的信息，页面渲染时详细的信息还是重数据库表里查出来。

9. 如果用户查询“最好看的全面屏手机”，怎么实现？

   全文检索的中文分词技术，提取其中的名词，忽略形容词，中文分词后剩下全面屏手机，再去ES里搜索。

10. 存放商品图片用什么图床？

    腾讯云...配置secret id、secret key



## 电商——秒杀业务

### 超售现象

- 备货100个，卖出超过100个商品
- 高并发下，MySQL和Redis都会出现超售现象

### 解决方案

- 事务隔离级别设置为串行（Serializable）
  - 效率
- 修改库存时对库存记录加锁（悲观锁）
  - 死锁
- 乐观锁机制
  - 通过数据记录的版本号来判断提高更新操作是否有冲突
  - version int not null 每次修改数据版本号加1
  - 用户个人信息和收货地址信息不需要加乐观锁，只有需要需改同一条数据的需要加
  - MyBatis-Plus @Version，相当于执行时增加 set version = newVersion where version = oldVersion



### Redis超售

一组指令命令发送给Redis执行，如果指令被插队，会出现超售现象。

### Redis事务机制

- Redis事务机制与数据库机制不同，Redis事务是一组批处理命令
- 因为客户端将多条指令一次性发送给Redis，而且Redis是单线程执行，所以不存在被其他命令打断。

### Redis事务的乐观锁

- 客户端提交批处理命令之前，需要先查询Redis上面的数据的版本号
  - WATCH kill_num 获取版本号
  - MULTI 开启事务
  - ... 一些操作
  - EXEC 提交事务



## 面试题

- 怎么设计一个秒杀系统
  1. 因为使用时间短、并发访问流量大，为了防止拖垮原网站，单独部署秒杀程序，分配独立域名。
  2. 用户在秒杀之前，为了不错过秒杀活动，用户会不断刷新页面查看是否开始，后台负载压力大，使用MySQL集群、Redis集群和负载均衡外，秒杀页面要静态化，避免渲染页面消耗过多资源。
  3. 秒杀时，短时间增大贷款，短时间租用云端资源，秒杀页面可以放在CDN节点上，减少秒杀页面的带宽。
  4. 避免秒杀前，用户提前获取下单页面的URL路径，需要对下单页面实行URL动态化。例如：秒杀开始后，服务端生成特殊规则的随机数，把随机数放在Redis，秒杀下单时必须带上随机数才能进入下单画面。避免提前进入下单页面。秒杀未开始，任何人不能进入下单画面。
  5. 秒杀开始时，更换CDN上的JS文件，到秒杀开始时间，页面自动刷新获取最新的JS文件。秒杀开始前，任何顾客不能发起秒杀请求。
  6. 扣减库存的方式合理设计
     1. 付款后扣减库存，不可取
     2. 下单时扣减库存，下单成功后，支付一定有货。
     3. 下单10分钟后，用户没有支付，系统自动释放订单占有的库存
  7. 避免超售，Mysql乐观锁、Redis事务
  8. MySQL集群、Redis集群、负载均衡、CDN加速。面对海量的请求要做好限流，比如后台系统引入消息队列，来拦截大量的请求。

- 怎么解决超售？

  秒杀活动开始前，在Redis里创建商品的库存记录，秒杀程序首先watch库存和成功抢购商品的用户列表，然后开启Redis事务，扣减库存和记录成功抢购商品的用户id，最后提交Redis事务。





















