# 09 计算机网络-网络篇

## **虚拟互连网络** 

- 实际的计算机网络是错综复杂的
- 物理设备通过使用IP协议，屏蔽了物理网络之间的差异 
- 当网络中的主机使用IP协议连接时，则无需关注网络细节 

## IP协议 

- IP地址长度为32位，常分成4个8位
- IP地址常使用点分十进制来表示(0~255.0~255.0~255.0~255) 

| 位版本  | 4位首部长度 | 8位服务类型(TOS) | 16位总长度(字节) |
| ----------------- | -------------------- | ----------------------------- | ------------------------------------ |
| 16位标识          | 3位 标志             | 13位片偏移  |
| 8位生存时间(TTL)  | 8位协议              | 16位首部校验和 |                                      |
| 32位源IP地址     |
| 32位目的IP地址     |
| 选项options(若有) |
| IP数据               |

- **版本**:占4位，指的是IP协议的 版本，通信双方的版本必须一 致，当前主流版本是4，即IPv4， 也有IPv6 
- **首部位长度**:占4位，最大数值 为15，表示的是IP首部长度， 单位是“32位字”(4个字节)， 也即是IP首部最大长度为60字节
- **总长度**:占16位，最大数值为 65535，表示的是IP数据报总长 度(IP首部+IP数据) 
- **标识 标志 片偏移** 
- **TTL**:占8位，表明IP数据报文 在网络中的寿命，每经过一个 设备，TTL减1，当TTL=0时， 网络设备必须丢弃该报文 
- **协议**:占8位，表明IP数据所携 带的具体数据是什么协议的 (如:TCP、UDP等) 

| **协议名** | **ICMP** | **IGMP** | **IP** | **TCP** | **UDP** | **OSPF** | **...** |
| ---------- | -------- | -------- | ------ | ------- | ------- | -------- | ------- |
| 字段值     | 1        | 2        | 4      | 6       | 17      | 89    | ...     |

- **首部校验和**:占16位，校验IP 首部是否有出错 
- **源IP地址 目的IP地址** 

## IP协议的转发流程 

**逐跳(hop-by-hop)** 

###**路由表简介** 

**计算机或者路由器都拥有路由表**

- A通过网卡发出数据帧
- 数据帧到达路由器，路由器取出前6字节
- 路由器匹配MAC地址表，找到对应的网络接口 
- 路由器往该网络接口发送数据帧 

### IP协议的转发流程

- A发出目的地为C的IP数据报，查询路由表发现下一跳为E 
- A将数据报发送给E
- E查询路由表发现下一跳为F，将数据报发送给F
- F查询路由表发现目的地C直接连接，将数据报发送给C 

**路由表** 

- A发出目的地为C的IP数据报，查询路由表发现下一跳为E 
- A将IP数据报交给数据链路层，并告知目的MAC地址是E 
- 数据链路层填充源MAC地址A和目的MAC地址E
- 数据链路层通过物理层将数据发送给E 
- E的数据链路层接收到数据帧，把帧数据交给网络层 
- E查询路由表，发现下一跳为F
- E把数据报交给数据链路层，并告知目的MAC地址为F 
- E的数据链路层封装数据帧并发送 
- F的数据链路层接收到数据帧，把帧数据交给网络层
- F查询路由表，发现下一跳为C
- F把数据报交给数据链路层，并告知目的MAC地址为C 
- F的数据链路层封装数据帧并发送 



- 数据帧每一跳的MAC地址都在变化 
- IP数据报每一跳的IP地址始终不变 



## ARP(Address Resolution Protocol)地址解析协议 

- ARP缓存表缓存有IP地址和MAC地址的映射关系 
- ARP缓存表没有缓存IP地址和MAC地址的映射关系 
- ARP缓存表是ARP协议和RARP协议运行的关键
- ARP缓存表缓存了IP地址到硬件地址之间的映射关系 
- ARP缓存表中的记录并不是永久有效的，有一定的期限 



## RARP(Reverse Address Resolution Protocol)逆地址解析协议 

- (R)ARP协议是TCP/IP协议栈里面基础的协议 
- ARP和RARP的操作对程序员是透明的
- 理解(R)ARP协议有助于理解网络分层的细节 



## IP地址的子网划分 

- IP地址长度为32位，常分成4个8位
- IP地址常使用点分十进制来表示(0~255.0~255.0~255.0~255) 



### 分类的IP地址

**特殊的主机号** 

- 主机号全0表示当前网络段，不可分配为特定主机
- 主机号为全1表示广播地址，向当前网络段所有主机发消息 

**特殊的网络号** 

- A类地址网络段全0(00000000)表示特殊网络
- A类地址网络段后7位全1(01111111:127)表示回环地址
- B类地址网络段(10000000.00000000:128.0)是不可使用的 
- C类地址网络段(192.0.0)是不可使用的 



|      | **最小网络号** | **最大网络号** | **子网数量** | **最小主机号** | **最大主机号** | **主机数量** |
| ---- | -------------- | -------------- | ------------ | -------------- | -------------- | ------------ |
| A    | 1              | 127 (01111111) | 2^7-2        | 0.0.0          | 255.255.255    | 2^24-2       |
| B    | 128.1          | 191.255        | 2^14-1       | 0.0            | 255.255        | 2^16-2       |
| C    | 192.0.1        | 223.255.255    | 2^21-1       | 0              | 255            | 2^8-2     |

127.0.0.1，通常被称为本地回环地址(Loopback Address)，不属于任何 一个有类别地址类。它代表设备的本地虚拟接口，所以默认被看作是永远 不会宕掉的接口。在Windows操作系统中也有相似的定义，所以通常在 安装网卡前就可以ping通这个本地回环地址。一般都会用来检查本地网络 协议、基本数据接口等是否正常的。 

### **划分子网** 

**子网掩码** 

- 子网掩码和IP地址一样，都是32位
- 子网掩码由连续的1和连续的0组成
- 某一个子网的子网掩码具备网络号位数个连续的1 

### 无分类编址CIDR 

**网络前缀是任意位数的** 

**相比原来子网划分更加灵活**

- CIDR中没有A、B、C类网络号、和子网划分的概念
- CIDR将网络前缀相同的IP地址称为一个“CIDR地址块” 



- 使用/18的子网掩码获得超网的网络号
- 使用/20的子网掩码获得二级超网的网络号 
- 使用/24的子网掩码获得子网的网络号 



## 网络地址转换NAT技术 

- IPv4最多只有40+亿个IP地址
- 早期IP地址的不合理规划导致IP号浪费 

- **内网地址** 
  - 内部机构使用
  - 避免与外网地址重复 
- **外网地址** 
  - 全球范围使用 
  - 全球公网唯一 

**三类内网地址**

- 10.0.0.0~10.255.255.255(支持千万数量级设备
- 172.16.0.0~172.31.255.255(支持百万数量级设备)
- 192.168.0.0~192.168.255.255(支持万数量级设备) 



- 网络地址转换NAT(Network Address Translation)
- NAT技术用于多个主机通过一个公有IP访问互联网的私有网络中 
- NAT减缓了IP地址的消耗，但是增加了网络通信的复杂度 

## ICMP协议详解

- 网际控制报文协议(Internet Control Message Protocol) 
- ICMP协议可以报告错误信息或者异常情况 



## Ping应用

| **ICMP****报文种类** | **类型的值**                  | **报文类型**          | **具体代码** |
| -------------------- | ----------------------------- | --------------------- | ------------ |
| 询问报文             | 0或8                          | 回送(Echo)请求或 应答 | -            |
| 13或14               | 时间戳 (Timestamp)请求 或应答 | -  |            |

- Ping回环地址127.0.0.1 
- Ping网关地址
- Ping远端地址 

## Traceroute应用 

Traceroute可以探测IP数据报在网络中走过的路径 



## **网络层的路由概述** 

- 每一顶点表示一个网络、路由器或计算机 
- 每一条边表示一条网络路径 
- 路由算法实际上是图论的算法
- 网络环境复杂 
- 路由算法要比图论的算法要复杂 
- 
- 算法是正确的、完整的
- 算法在计算上应该尽可能的简单 
- 算法可以适应网络中的变化
- 算法是稳定的和公平的 
- 算法可以适应网络中的变化
- 算法是稳定的和公平的 



**自治系统(Autonomous System) **

- 一个自治系统(AS)是处于一个管理机构下的网络设备群
- AS内部网络自行管理，AS对外提供一个或者多个出(入)口 
- 自治系统内部路由的协议称为:内部网关协议(RIP、OSPF) 
- 自治系统外部路由的协议称为:外部网关协议(BGP) 

### **距离矢量(DV)算法** 

- 每一个节点使用两个向量𝐷 和S 𝑖𝑖 
- 𝐷 描述的是当前节点到别的节点的距离 𝑖 
- S𝑖 描述的是当前节点到别的节点的下一节点 
- 每一个节点与相邻的节点交换向量𝐷 和S 的信息 𝑖𝑖 
- 每一个节点根据交换的信息更新自己的节点信息 



**𝑑𝑖𝑗 = min(𝑑𝑖x + 𝑑x𝑗)** 

- 𝑑𝑖1表示从节点i到节点1的距离 
- 𝑠𝑖1表示从节点i到节点1的下一个节点
- 𝑛表示节点的数量 



- 每一个节点使用两个向量𝐷 和S 𝑖𝑖 
- 𝐷 描述的是当前节点到别的节点的距离 𝑖 
- S𝑖 描述的是当前节点到别的节点的下一节点 
- 每一个节点与相邻的节点交换向量𝐷 和S 的信息 𝑖𝑖 
- 每一个节点根据交换的信息更新自己的节点信息 



## RIP协议的过程 

- RIP(Routing Information Protocol)协议 
- RIP协议是使用DV算法的一种路由协议 
- RIP协议把网络的跳数(hop)作为DV算法的距离 
- RIP协议每隔30s交换一次路由信息
- RIP协议认为跳数>15的路由则为不可达路由 



1. 路由器初始化路由信息(两个向量𝐷 和S ) 𝑖𝑖 
2. 对相邻路由器X发过来的信息，对信息的内容进行修改(下一跳地址设置为X，所有距离加1) 
      1. i. 检索本地路由，将信息中新的路由插入到路由表里面
      2. ii. 检索本地路由，对于下一跳为X的，更新为修改后的信息
      3. iii. 检索本地路由，对比相同目的的距离，如果新信息的距离更小，则更新本地路由表 

3. 如果3分钟没有收到相邻的路由信息，则把相邻路由设置为不可达(16跳) 



1. 路由器初始化路由信息(两个向量𝐷 和S ) 𝑖𝑖 

2. 对相邻路由器X发过来的信息，对信息的内容进行修改(下一跳地址设置为X，所有距离加1) i. 检索本地路由，将信息中新的路由插入到路由表里面 



1. 路由器初始化路由信息(两个向量𝐷 和S ) 𝑖𝑖 

2. 对相邻路由器X发过来的信息，对信息的内容进行修改(下一跳地址设置为X，所有距离加1) 
   1. i. 检索本地路由，将信息中新的路由插入到路由表里面
   2.  ii. 检索本地路由，对于下一跳为X的，更新为修改后的信息 
   3. iii. 检索本地路由，对比相同目的的距离，如果新信息的距离更小，则更新本地路由表 
3. 如果3分钟没有收到相邻的路由信息，则把相邻路由设置为不可达(16跳) 



- RIP协议:实现简单，开销很小
- RIP协议:限制了网络的规模
- RIP协议:“坏消息传的慢”，更新收敛时间过长 



## Dijkstra(迪杰斯特拉)算法 

- Dijkstra算法是著名的图算法
- Dijkstra算法解决有权图从一个节点到其他节点的最短路径问题
- “以起始点为中心，向外层层扩展” 



1. 初始化两个集合(S, U)(S为只有初始顶点点A的集合，U为其他顶点集合)
2. 如果U不为空， 对U集合顶点进行距离的排序，并取出距离A最近的一个顶点D
   1. i. 将顶点D的纳入S集合 
2. ii.更新通过顶点D到达U集合所有点的距离(如果距离更小则更新，否则不更新) 
   3. iii. 重复2步骤 
   
3. 知道U集合为空，算法完成 



## 内部网关路由协议之OSPF协议

### 链路状态(LS)协议 

- 向所有的路由器发送消息 
- 消息描述该路由器与相邻路由器的链路状态 
- 只有链路状态发生变化时，才发送更新信息 

### **OSPF****协议的过程** 

- OSPF(Open Shortest Path First:开放最短路径优先) 
- OSPF协议的核心是Dijkstra算法 

#### **五种消息类型** 

- 问候消息(Hello)
- 链路状态数据库描述信息 
- 链路状态请求信息 
- 链路状态更新信息 
- 链路状态确认信息 

| **RIP****协议**             | **OSPF****协议**                    |
| --------------------------- | ----------------------------------- |
| 从邻居看网络                | 整个网络的拓扑                      |
| 在路由器之间累加距离        | Dijkstra算法计算最短路径            |
| 频繁、周期更新，收敛很慢  | 状态变化更新，收敛很快              |
| 路由间拷贝路由信息          | 路由间传递链路状态，自行计算路径  |



## 外部网关路由协议之BGP协议 

- BGP(Border Gateway Protocol: 边际网关协议) 
- BGP协议是运行在AS之间的一种协议 
- 互联网的规模很大
- AS内部使用不同的路由协议 
- AS之间需要考虑除网络特性以外的一些因素(政治、安全...) 
- BGP(Border Gateway Protocol，边界网关协议) 
- BGP协议能够找到一条到达目的比较好的路由 

**BGP发言人(speaker)** 

- BGP并不关心内部网络拓扑
- AS之间通过BGP发言人交流信息 
- BGP Speaker可以人为配置策略 



- BGP协议能够找到一条到达目的比较好的路由 
- AS之间通过BGP发言人来进行路由信息的交换 



