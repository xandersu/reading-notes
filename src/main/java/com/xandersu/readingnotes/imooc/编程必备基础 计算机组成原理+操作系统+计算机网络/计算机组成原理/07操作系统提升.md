# 07操作系统提升

##线程同步之互斥量 

- 两个线程的指令交叉执行 
- 互斥量可以保证先后执行 

**原子性** 

- 原子性是指一系列操作不可被中断的特性
- 这一系列操作要么全部执行完成，要么全部没有执行 
- 不存在部分执行部分未执行的情况 

### 互斥量

- 互斥量是最简单的线程同步的方法
- 互斥量(互斥锁)，处于两态之一的变量:解锁和加锁 
- 两个状态可以保证资源访问的串行 
- 操作系统直接提供了互斥量的API
- 开发者可以直接使用API完成资源的加锁、解锁操作 
- pthread_mutex_t
- pthread_mutex_lock 
- pthread_mutex_unlock 

## **线程同步之自旋锁** 

死循环等待锁被释放 

- 自旋锁也是一种多线程同步的变量
- 使用自旋锁的线程会反复检查锁变量是否可用 
- 自旋锁不会让出CPU，是一种忙等待状态 
- 自旋锁避免了进程或线程上下文切换的开销 
- 操作系统内部很多地方使用的是自旋锁
- 自旋锁不适合在单核CPU使用 
- pthread_spinlock_t
- pthread_ spinlock _lock
- pthread_ spinlock _unlock 

## **线程同步之读写锁** 

- 临界资源多读少写
- 读取的时候并不会改变临界资源的值 



- 读写锁是一种特殊的自旋锁
- 允许多个读者同时访问资源以提高读性能 
- 对于写操作则是互斥的 
- pthread_rwlock_t
- pthread_rwlock_rdlock(读锁) 
- pthread_rwlock_wrlock(写锁) 

## **线程同步之条件变量** 

- 条件变量是一种相对复杂的线程同步方法
- 条件变量允许线程睡眠，直到满足某种条件 
- 当满足条件时，可以向该线程信号，通知唤醒 



当生产者生产一个产品时，唤醒可能等待的消费者 

当消费者消费一个产品时，唤醒可能等待的生产者 

- 缓冲区小于等于0时，不允许消费者消费，消费者必须等待 
- 缓冲区满时，不允许生产者往缓冲区生产，生产者必须等待 



- pthread_cond_t
- pthread_cond_wait(等待条件满足) 
- pthread_cond_signal(等待被唤醒) 



| **同步方法** | **描述**                                                  |
| ------------ | ------------ |
| 互斥锁       | 最简单的一种线程同步方法，会阻塞线程|
| 自旋锁       | 避免切换的一种线程同步方法，属于“忙等待”  |
| 读写锁    |为“读多写少”的资源设计的线程同步方法，可以显著提高性能|
| 条件变量   | 相对复杂的一种线程同步方法，有更灵活的使用场景 |

# 使用fork系统调用创建进程

- fork系统调用是用于创建进程的
- fork创建的进程初始化状态与父进程一样 
- 系统会为fork的进程分配新的资源
- fork系统调用无参数
- fork会返回两次，分别返回子进程id和0
- 返回子进程id的是父进程，返回0的是子进程 

## **进程同步之共享内存** 

进程默认是不能访问进程空间之外的内存空间的

共享内存是高性能后台开发中最常用的进程同步方式

- 在某种程度上，多进程是共同使用物理内存的
- 由于操作系统的进程管理，进程间的内存空间是独立的 
- 共享存储允许不相关的进程访问同一片物理内存
- 共享内存是两个进程之间共享和传递数据最快的方式 
- 共享内存未提供同步机制，需要借助其他机制管理访问 



1. 申请共享内存 
2. 连接到进程空间 
3. 使用共享内存 
4. 脱离进程空间 &删除 



## 进程同步之Unix域套接字 

- 域套接字是一种高级的进程间通信的方法 
- Unix域套接字可以用于同一机器进程间通信 
- 套接字(socket)原是网络通信中使用的术语
- Unix系统提供的域套接字提供了网络套接字类似的功能 
- 提供了单机简单可靠的进程通信同步服务 
- 只能在单机使用，不能跨机器使用 

服务端

1. 创建套接字 
2. 绑定(bind)套接字 
3. 监听(listen)套接字 
4. 接收&处理信息 

客户端

1. 创建套接字 
2. 连接套接字 
3. 发送信息 



## 操作系统的用户态与内核态



## **理解上下文切换** 



## **进程、线程与协程** 





# 08 操作系统时实践

## 实现线程安全的队列Queue 

- 队列用于存放多个元素，是存放各种元素的“池” 
- 队列可能有多个线程同时操作，因此需要保证线程安全 

**实现线程安全的队列** ：

1. 获取当前队列元素数量 
2. 往队列放入元素 
3. 从队列取出元素 



多个线程同时访问队列元素（保证多个线程获取的串行 ）：使用“锁”保护队列 

队列元素为空时获取队列元素（阻塞，等待队列不为空 ）：使用条件变量等待队列元素



## 线程池简介 

- 线程池是存放多个线程的容器
- CPU调度线程执行后不会销毁线程 
- 将线程放回线程池重复利用 

**为什么使用线程池** 

- 线程是稀缺资源，不应该频繁创建和销毁
- 架构解耦，线程创建和业务处理解耦，更加优雅 
- 线程池是使用线程的最佳实践 











