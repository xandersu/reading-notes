# 11 计算机网络-传输层

**管理端到端的通信连接** 

进程与进程的通信 

- Unix域套接字 
- 共享内存 
- 网络通信 

## **传输层概述** 

- 使用端口(Port)来标记不同的网络进程 
- 端口(Port)使用16比特位表示(0~65535) 

| **FTP** | **HTTP** | **HTTPS** | **DNS** | **TELNET** |
| ------- | -------- | --------- | ------- | ---------- |
| 21      | 80       | 443       | 53      | 23    |



UDP ：UDP协议

TCP ：TCP协议 、三次握手、四次释放 、TCP协议可靠传输 、TCP协议流量控制、TCP协议拥塞控制 



## UDP协议 

- UDP(User Datagram Protocol: 用户数据报协议) 
- UDP是一个非常简单的协议 

应用层数据 

UDP首部 | UDP数据报的数据 

IP首部 | IP数据报的数据 

IP数据报

帧首部 | 帧”的数据 | 帧尾部 



16位源端口号 | 16位目的端口号
16位UDP长度 | 16位UDP校验和
       UDP数据

- UDP是无连接协议 

- UDP不能保证可靠的交付数据 （“想发就发”，“无法保证数据在网络中是否丢失）

- UDP是面向报文传输的 （
  应用层数据 
  UDP首部  |  UDP数据报的数据 
  ）

- UDP没有拥塞控制 

- UDP的首部开销很小 



## TCP协议

- TCP(Transmission Control Protocol: 传输控制协议) 
- TCP协议是计算机网络中非常复杂的一个协议 

TCP首部 | TCP数据报的数据 

IP首部 | IP数据报的数据 

IP数据报

帧首部 | 帧”的数据 | 帧尾部 

- TCP是面向连接的协议
- TCP的一个连接有两端(点对点通信) 
-  TCP提供可靠的传输服务 
- TCP协议提供全双工的通信 
- TCP是面向字节流的协议 

16位源端口  |  16位目的端口
序号
确认号
数据偏移   |  保留字段  |  TCP标记  |  窗口
校验和  |  紧急指针
TCP选项(可选)  |  填充

### **序号** 

- 0~2^32-1
- 一个字节一个序号 
- 数据首字节序号 

### **确认号** 

- 0~2^32-1
- 一个字节一个序号
- 期望收到数据的首字节序号 
- 确认号为N:则表示N-1序号的数据都已经收到 

### **数据偏移** 

- 占4位:0~15，单位为:32位字 
- 数据偏离首部的距离 

### TCP标记

占6位，每位各有不同意义 

| **标记** | **含义**                                        |
| -------- | ----------------------------------------------- |
| URG      | Urgent: 紧急位，URG=1，表示紧急数据             |
| ACK      | Acknowledgement: 确认位，ACK=1，确认号才生效    |
| PSH      | Push: 推送位，PSH=1，尽快地把数据交付给应用层   |
| RST      | Reset: 重置位，RST=1，重新建立连接              |
| SYN      | Synchronization: 同步位，SYN=1 表示连接请求报文 || FIN      | Finish: 终止位，FIN=1 表示释放连接              |

### **窗口** 

-  占16位:0~2^16-1
- 窗口指明允许对方发送的数据量 

### **校验和** 

### **紧急指针** 

- 紧急数据(URG=1)
- 指定紧急数据在报文的位置 

### TCP选项 

- 最多40字节
- 支持未来的拓展 

##**可靠传输的基本原理** 

- 停止等待协议 
- 连续ARQ协议 

###停止等待协议 

超时重传 

**可靠传输** 

- 发送的消息在路上丢失了 
- 确认的消息在路上丢失了 
- 确认的消息很久才到 

**超时定时器** 

每发送一个消息，都需要设置一个定时器 



- 停止等待协议是最简单的可靠传输协议 
- 停止等待协议对信道的利用效率不高 

## 连续ARQ协议 

- ARQ(Automatic Repeat reQuest:自动重传请求) 



## TCP协议的可靠传输

TCP的可靠传输基于连续ARQ协议 

TCP的滑动窗口以字节为单位 



## TCP协议的选择重传 

- 选择重传需要指定需要重传的字节 
- 每一个字节都有唯一的32位序号 



## TCP协议的流量控制 

- TCP协议使用滑动窗口实现流量控制 
- 坚持定时器的作用 

**窗口** 

- 占16位:0~2^16-1
- 窗口指明允许对方发送的数据 

### **坚持定时器** 

- 当接收到窗口为0的消息，则启动坚持定时器
- 坚持定时器每隔一段时间发送一个窗口探测报文 



## TCP协议的拥塞控制 

- 一条数据链路经过非常多的设备
- 数据链路中各个部分都有可能成为网路传输的瓶颈 
- 流量控制考虑点对点的通信量的控制
- 拥塞控制考虑整个网络，是全局性的考虑 
- 报文超时则认为是拥塞 

### **慢启动算法** 

- 由小到大逐渐增加发送数据量 
- 每收到一个报文确认，就加一 
- 维护一个拥塞窗口的变量
- 只要网络不拥塞，就试探着拥塞窗口调大 
- 慢启动阈值(ssthresh) 



##为什么发送方要发出第三个确认报文呢?

- 已经失效的连接请求报文传送到对方，引起错误 



## TCP连接的释放 

2MSL 

- MSL(Max Segment Lifetime): 最长报文段寿命 
- MSL建议设置为2分钟 

### 为什么需要等待2MSL? 

- 最后一个报文没有确认 
- 确保发送方的ACK可以到达接收方
- 2MSL时间内没有收到，则接收方会重发 
- 确保当前连接的所有报文都已经过期 



## **套接字与套接字编程** 

- 使用端口(Port)来标记不同的网络进程 
- 端口(Port)使用16比特位表示(0~65535) 
- 套接字(Socket)是抽象概念，表示TCP连接的一端 
- 通过套接字可以进行数据发送或接收 
- TCP连接由两个套接字组成 :TCP= {𝑆𝑜𝑐𝑘𝑒𝑡1:𝑆𝑜𝑐𝑘𝑒𝑡2} = { {𝐼𝑃: 𝑃𝑜𝑟𝑡 𝐼𝑃: 𝑃𝑜𝑟𝑡 }  }



创建套接字 => 绑定(bind)套接字  =>  监听(listen)套接字  =>  接收&处理信息

创建套接字 => 连接套接字 => 发送信息 

















