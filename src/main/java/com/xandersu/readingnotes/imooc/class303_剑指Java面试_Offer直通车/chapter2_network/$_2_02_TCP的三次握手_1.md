# 2-02 TCP的三次握手_1

**ip协议：**无连接的通信协议，不会占用两个正在通信的计算机之间的通信线路，这样IP就降低了对网络线路的需求，每条线可以同时满足许多不同的计算机之间的通信需要，通过ip，数据会分割成较小的独立的包，并通过internet在计算机之间传送。ip负责将每个包路由到他的目的地，但ip协议没有做任何事情来确认数据包是否按顺序发送，或者包是否被破坏，所以ip数据包是不可靠的，需要有他的上层协议来控制。

[![JiJM9A.gif](https://s1.ax1x.com/2020/04/15/JiJM9A.gif)](https://imgchr.com/i/JiJM9A)

## 说说tcp三次握手

### 传输控制协议TCP简介：

- 面向连接的、可靠的、基于字节流的传输层通信协议
- 将应用层的数据流分割成报文段并发送给目标节点的TCP层
- 数据包都有序号，对方收到则发送ACK确认，未收到则重传
- 使用校验和来校验数据在传输过程中是否有误

### TCP报文头

### TCP Flags

TCP报文是TCP层传输的数据单元，也称为报文段。

![Ji8HsK.jpg](https://s1.ax1x.com/2020/04/15/Ji8HsK.jpg)

- souce port：源端口，2字节

- destination port：目标端口，2字节

> TCP\UDP都不包含ip地址信息的，因为那是ip层的事情
>
> 端口是传输层范畴的
>
> 两个进程在计算机内部通信：管道、内存共享、信号量、消息队列
>
> 两个进程进行通信的前提是，能够唯一的标识一个进程，通过这个标识找到进程
>
> 本地进程：PID本地唯一
>
> ip地址可以唯一标识主机
>
> tcp协议和端口号可以唯一标识主机中的一个进程
>
> ip地址+协议+端口号标识网络中的一个进程，也叫套接字socket

- Sequence Number：seq序号，4字节，TCP连接中传送的字节流中的每个字节都按顺序编号了。
- Acknowledgment Number：ACK，确认号，4字节，期望收到对方下一个报文的第一个数据字节的序号。
- Offset：长度不固定。TCP报文数据距离TCP报文的起始处有多远。
- Reserved：保留域。表为0。
- Control Bits：控制位。
  - URG：紧急指针标志。1：紧急指针有效。0：忽略紧急指针。表示TCP包的紧急指针字段有效，用来保证TCP连接不被中断，并且督促中间齐备尽快处理这些数据。
  - ACK：确认序号标志。1：确认号有效。0：报文中不含确认信息，忽略确认号字段。确认号是否有效是这位控制的。
  - PSH：push标志。1：带有PUSH标志的数据，指示数据包到达接收端以后，尽快交给应用程序，而不是在缓冲区中排队。
  - RST：重置连接标志。重置由于主机崩溃或者其他原因而出现错误的连接，或者用于拒绝非法的报文段和拒绝连接请求。
  - SYN：同步序号，用于建立连接过程。SYN=1，ACK=0表示该数据段没有使用捎带的确认域；SYN=1，ACK=1连接应答捎带确认。
  - FIN：finish标志，用于释放标志。1：发送方没有数据发送了，关闭本方数据流。
- Window：窗口，指的是滑动窗口的大小。用来告知发送端接收端的缓存大小，依次控制发送端发送数据的速率，从而达到流量控制。
- Checksum：检验和，奇偶校验，此校验和是对整个的TCP报文段包括TCP头部和TCP数据以16位进行计算所得，由发送端计算和存储并由接收端进行验证。
- Urgent Pointer：紧急指针，只有URG为1有效，指出本报文段的紧急数据的字节数。
- Option：可选项，长度可变。定义一些可选参数。

### "握手"是为了建立连接，TCP三次握手的流程图：

在Tcp/IP 协议中，TCP协议提供可靠的连接服务，采用三次握手建立一个连接。
第一次握手：建立连接时，客户端发送SYN包（syn=j）到服务器，并进入SYN_SEND状态，等待服务器确认。

第二次握手：服务器收到SYN包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态。

第三次握手：客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK（ack=ack+1），此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。

## 为什么需要三次握手才能创建连接

为了初始化Sequence Number的初始值

### 问题起因分析：

- Server收到SYN，恢复SYN-ACK的时候未收到ACK确认
- Server不断重试直至超时，Linux默认等待63秒才断开连接

### 针对SYN Flood的防护措施

- SYN队列满后，通过tcp_syncookies参数回发SYN Cookie
- 若为正常连接则Client会回发SYN Cookie，直接建立连接

## 建立连接后，Client出现故障怎么办
### 保活机制

- 向对方发送保活探测报文，如果未收到相应则继续发送
- 尝试次数达到保活探测数仍未收到相应则中断连接

