# 第六章 类文件结构

## 6.2 无关性基石

各种不同的平台的虚拟机与所有平台都统一使用的程序存储格式——字节码（ByteCode）是构成平台无关性的基石。

虚拟机的另外一种中立特性——语言无关性。

Clojure、Groovy、JRuby、Jython、Scala

实现语言无关性的基础仍是虚拟机和字节码存储格式。JVM不与语言绑定，只与Class文件这种特定的二进制文件格式所关联，Class文件中包含了JVM指令集和符号表以及若干其他辅助信息。基于安全性考虑，JVM规范要求在Class文件中使用许多强制性的语法和结构化约束，任意一门语言都可以为可以被JVM接受的有效的Class文件。作为一个通用的、机器无关的执行平台，其他语言的实现者都可以将JVM作为语言的产品交付媒介。

## 6.3 Class类文件的结构

任何一个Class文件都对应着唯一一个类或者接口的定义信息，但类和接口并不一定定义在文件里（也可以通过类加载器直接生成）。

Class文件是一组以8位字节为基础单位的二进制流。当需要占用8位字节以上的空间的数据项时，则会按照高位在前（Big-Endian，最高位字节在地址的最低位、最低位字节在地址最高位的顺序）的方式分割成若干个8位字节进行存储。

JVM规范规定，Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，两种数据结构：无符号数和表。

无符号数数据基本数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节、8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成的字符串值。

表是由多个无符号数或者其他表作为数据项构成的复合数据类型，所有表都习惯性以“_info”结尾。表用于描述有层次关系的复合结构的数据，整个Class文件本质上就是一张表。

| 类型           | 名称                | 数量                  |
| -------------- | ------------------- | --------------------- |
| u4             | magic               | 1                     |
| u2             | minor_version       | 1                     |
| u2             | major_version       | 1                     |
| u2             | constant_pool_count | 1                     |
| cp_info        | constant_pool       | constant_pool_count-1 |
| u2             | access_flags        | 1                     |
| u2             | this_class          | 1                     |
| u2             | super_class         | 1                     |
| u2             | interfaces_count    | 1                     |
| u2             | interfaces          | interfaces_count      |
| u2             | fields_count        | 1                     |
| field_info     | fields              | fields_count          |
| u2             | methods_count       | 1                     |
| method_info    | methods             | methods_count         |
| u2             | atrributes_count    | 1                     |
| atrribute_info | atrributes          | atrributes_count      |

无论是无符号数还是表，当需要描述同一类型但数量不定的多个数据时，经常会用一个前置的容量计数器加若干个连续的数据项的形式，称这一系列连续的某一类型的数据为某一类型的集合。

class文件里的数据项，无论是顺序还是数量，甚至于数据存储的字节序（Byte Ordering，class文件中字节序是Big-Endian）细节，都是被严格限定的，含义长度顺序不允许改变。

### 6.3.1 魔数与Class文件的版本

每个Class文件的头4个字节称为魔数（Magic number），唯一作用是确定这个文件是否为一个能被虚拟机接收的Class文件。

Class文件的魔数值为：0xCAFEBABE。

紧接着魔数的4个字节存储的是Class文件的版本号：第5、6个字节是此版本号（minor_version），第7、8个字节是主版本号（major_version）。从45开始每个JDK大版本加1。高版本可以向下兼容，但不能运行之后版本的Class文件，即使文件格式没有任何变化。

JDK1.7主版本号最大值是51。

### 6.3.2 常量池

常量池理解为Class文件中的资源仓库，
